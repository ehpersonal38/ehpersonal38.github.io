<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>YouTubeÂ +Â DancerÂ BPMÂ Sync</title>
<style>
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,sans-serif}
  body{margin:0;padding:1rem;background:#111;color:#eee}
  h1{margin:0 0 .5rem;font-size:1.4rem;text-align:center}
  .row{display:flex;gap:1rem;align-items:flex-start}
  #playerBox,#gifBox{flex:1}
  #gifBox canvas{max-width:100%;height:auto;border:2px solid #444;border-radius:6px}
  #controls{margin:.5rem 0;text-align:center}
  input[type=text]{width:70%;max-width:420px;padding:.4rem;border-radius:4px;border:1px solid #555;background:#222;color:#eee}
  button{padding:.45rem .8rem;margin-left:.4rem;border:none;border-radius:4px;background:#e91e63;color:#fff;cursor:pointer}
  button:hover{background:#ff2d75}
  small{display:block;margin-top:.4rem;color:#aaa}
</style>
</head>
<body>
<h1>ğŸ§Â Pick a YouTube track &amp; watch the dancer match its BPM</h1>

<div id="controls">
  <form id="searchForm">
    <input id="query" type="text" placeholder="Search YouTube or paste a full URL" required/>
    <button type="submit">Play â–¶</button>
  </form>
  <small>Tip: if the video title contains â€œ123Â BPMâ€, the dancer will autoâ€‘sync.<br>
        Otherwise enter a BPM manually here â†’ <input id="manualBpm" type="number" min="40" max="250" step="1" placeholder="BPM"> </small>
</div>

<div class="row">
  <div id="playerBox">
    <!-- The YouTube player will appear here -->
    <div id="player"></div>
  </div>

  <div id="gifBox">
    <!-- dance.gif rendered onto canvas so we can change playback speed -->
    <canvas id="danceCanvas"></canvas>
  </div>
</div>

<!-- â–¶Â YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- â–¶Â gifler (renders GIF â†’Â canvas with playback control) -->
<script src="https://cdn.jsdelivr.net/npm/gifler@0.1.0/build/gifler.min.js"></script>

<script>
/* ---------- 1. Load & prepare the dancer GIF ---------- */
let gifController, defaultFPS=24;    // updated after GIF loads

gifler('dance.gif').get((anim) => {
  const canvas = document.getElementById('danceCanvas');
  anim.animateInCanvas(canvas);
  gifController = anim;                         // keep reference
  defaultFPS = anim._frames.length / (anim._duration/1000); // frames per second
});

/* ---------- 2. YouTube Player setup ---------- */
let player;
function onYouTubeIframeAPIReady(){
  player = new YT.Player('player', {
    height:'360', width:'640',
    videoId:'',            // empty until user searches
    playerVars:{ autoplay:1, rel:0, modestbranding:1 },
    events:{ onStateChange:onPlayerStateChange }
  });
}

/* ---------- 3. Respond to play / change events ---------- */
function onPlayerStateChange(event){
  if(event.data === YT.PlayerState.PLAYING){
    syncGifWithBpm();
  }
}

/* ---------- 4. Estimate BPM & sync ---------- */
function parseBpmFromTitle(title){
  const match = title.match(/(\d{2,3})\s*bpm/i);
  return match ? +(match[1]) : null;
}

function syncGifWithBpm(){
  const title = player.getVideoData().title || '';
  let bpm = parseBpmFromTitle(title);

  // fallback to manual bpm input
  const manual = +document.getElementById('manualBpm').value;
  if(!bpm && manual) bpm = manual;

  if(bpm && gifController){
    const speed = bpm / 120;                // 120Â BPM â‰™ GIFâ€™s native pace
    gifController.setSpeed(speed);          // gifler: 1.0 = normal
  }
}

/* ---------- 5. Mini search/URL loader ---------- */
document.getElementById('searchForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const q = document.getElementById('query').value.trim();
  if(!q) return;

  if(q.startsWith('http')){
    // full YouTube URL â‡’ extract v=
    const id = (new URL(q)).searchParams.get('v');
    if(id) player.loadVideoById(id);
  }else{
    // search query â‡’ create onâ€‘theâ€‘fly playlist using listType=search
    player.loadPlaylist({listType:'search', list:q, index:0});
  }
});
</script>
</body>
</html>
